<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>libspdm_com_context_data_session.c</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
/**
 *  Copyright Notice:
 *  Copyright 2021-2022 DMTF. All rights reserved.
 *  License: BSD 3-Clause License. For full text see link: https://github.com/DMTF/libspdm/blob/main/LICENSE.md
 **/

#include "internal/libspdm_secured_message_lib.h"

/**
 * This function initializes the session info.
 *
 * @param  spdm_context                  A pointer to the SPDM context.
 * @param  session_id                    The SPDM session ID.
 **/
void libspdm_session_info_init(libspdm_context_t *spdm_context,
                               libspdm_session_info_t *session_info,
                               uint32_t session_id, bool use_psk)
<span style = "background-color:#dfd">{</span>
    libspdm_session_type_t session_type;
    uint32_t capabilities_flag;

<span style = "background-color:#dfd">    if (session_id != INVALID_SESSION_ID) {</span>
<span style = "background-color:#fdd">        if (use_psk) {
            LIBSPDM_ASSERT((spdm_context-&gt;max_psk_session_count == 0) ||</span>
                           (spdm_context-&gt;current_psk_session_count &lt;
                            spdm_context-&gt;max_psk_session_count));
<span style = "background-color:#fdd">            spdm_context-&gt;current_psk_session_count++;
        } else {
            LIBSPDM_ASSERT((spdm_context-&gt;max_dhe_session_count == 0) ||</span>
                           (spdm_context-&gt;current_dhe_session_count &lt;
                            spdm_context-&gt;max_dhe_session_count));
<span style = "background-color:#fdd">            spdm_context-&gt;current_dhe_session_count++;</span>
        }
<span style = "background-color:#fdd">    } else {</span>
<span style = "background-color:#dfd">        if (use_psk) {</span>
<span style = "background-color:#fdd">            if (spdm_context-&gt;current_psk_session_count &gt; 0) {
                spdm_context-&gt;current_psk_session_count--;</span>
            }
<span style = "background-color:#fdd">        } else {</span>
<span style = "background-color:#dfd">            if (spdm_context-&gt;current_dhe_session_count &gt; 0) {</span>
<span style = "background-color:#fdd">                spdm_context-&gt;current_dhe_session_count--;</span>
            }
        }
    }

<span style = "background-color:#dfd">    capabilities_flag = spdm_context-&gt;connection_info.capability.flags &amp;</span>
                        spdm_context-&gt;local_context.capability.flags;
<span style = "background-color:#dfd">    switch (capabilities_flag &amp;</span>
            (SPDM_GET_CAPABILITIES_REQUEST_FLAGS_ENCRYPT_CAP |
             SPDM_GET_CAPABILITIES_REQUEST_FLAGS_MAC_CAP)) {
    case 0:
<span style = "background-color:#dfd">        session_type = LIBSPDM_SESSION_TYPE_NONE;
        break;</span>
    case (SPDM_GET_CAPABILITIES_REQUEST_FLAGS_ENCRYPT_CAP |
          SPDM_GET_CAPABILITIES_REQUEST_FLAGS_MAC_CAP):
<span style = "background-color:#fdd">        session_type = LIBSPDM_SESSION_TYPE_ENC_MAC;
        break;</span>
    case SPDM_GET_CAPABILITIES_REQUEST_FLAGS_MAC_CAP:
<span style = "background-color:#fdd">        session_type = LIBSPDM_SESSION_TYPE_MAC_ONLY;
        break;</span>
    default:
<span style = "background-color:#fdd">        LIBSPDM_ASSERT(false);
        session_type = LIBSPDM_SESSION_TYPE_MAX;</span>
        break;
    }

#if !(LIBSPDM_RECORD_TRANSCRIPT_DATA_SUPPORT)
<span style = "background-color:#dfd">    if (session_info-&gt;session_transcript.digest_context_th != NULL) {</span>
<span style = "background-color:#fdd">        libspdm_hash_free (spdm_context-&gt;connection_info.algorithm.base_hash_algo,</span>
                           session_info-&gt;session_transcript.digest_context_th);
<span style = "background-color:#fdd">        session_info-&gt;session_transcript.digest_context_th = NULL;</span>
    }
<span style = "background-color:#dfd">    if (session_info-&gt;session_transcript.digest_context_th_backup != NULL) {</span>
<span style = "background-color:#fdd">        libspdm_hash_free (spdm_context-&gt;connection_info.algorithm.base_hash_algo,</span>
                           session_info-&gt;session_transcript.digest_context_th_backup);
<span style = "background-color:#fdd">        session_info-&gt;session_transcript.digest_context_th_backup = NULL;</span>
    }
#endif

<span style = "background-color:#dfd">    libspdm_zero_mem (&amp;(session_info-&gt;last_key_update_request), sizeof(spdm_key_update_request_t));
    libspdm_zero_mem(session_info, offsetof(libspdm_session_info_t, secured_message_context));
    libspdm_secured_message_init_context(session_info-&gt;secured_message_context);
    session_info-&gt;session_id = session_id;
    session_info-&gt;use_psk = use_psk;
    libspdm_secured_message_set_use_psk(session_info-&gt;secured_message_context, use_psk);
    libspdm_secured_message_set_session_type(session_info-&gt;secured_message_context, session_type);
    libspdm_secured_message_set_sequence_number_endian(session_info-&gt;secured_message_context,</span>
                                                       spdm_context-&gt;sequence_number_endian);
<span style = "background-color:#dfd">    libspdm_secured_message_set_max_spdm_session_sequence_number(</span>
        session_info-&gt;secured_message_context, spdm_context-&gt;max_spdm_session_sequence_number);
<span style = "background-color:#dfd">    libspdm_secured_message_set_algorithms(</span>
        session_info-&gt;secured_message_context,
        spdm_context-&gt;connection_info.version,
        spdm_context-&gt;connection_info.secured_message_version,
        spdm_context-&gt;connection_info.algorithm.base_hash_algo,
        spdm_context-&gt;connection_info.algorithm.dhe_named_group,
        spdm_context-&gt;connection_info.algorithm.aead_cipher_suite,
        spdm_context-&gt;connection_info.algorithm.key_schedule);
<span style = "background-color:#dfd">    session_info-&gt;session_transcript.message_encap_d.max_buffer_size =</span>
        sizeof(session_info-&gt;session_transcript.message_encap_d.buffer);
#if LIBSPDM_RECORD_TRANSCRIPT_DATA_SUPPORT
    session_info-&gt;session_transcript.message_k.max_buffer_size =
        sizeof(session_info-&gt;session_transcript.message_k.buffer);
    session_info-&gt;session_transcript.message_f.max_buffer_size =
        sizeof(session_info-&gt;session_transcript.message_f.buffer);
    session_info-&gt;session_transcript.message_m.max_buffer_size =
        sizeof(session_info-&gt;session_transcript.message_m.buffer);
#endif
<span style = "background-color:#dfd">}</span>

/**
 * Set the psk_hint to a session info.
 *
 * @param  session_info                  A pointer to a session info.
 * @param  psk_hint                      Indicate the PSK hint.
 * @param  psk_hint_size                  The size in bytes of the PSK hint.
 */
void libspdm_session_info_set_psk_hint(libspdm_session_info_t *session_info,
                                       const void *psk_hint,
                                       size_t psk_hint_size)
{
    libspdm_secured_message_set_psk_hint(
        session_info-&gt;secured_message_context,
        psk_hint,
        psk_hint_size);
}

/**
 * This function gets the session info via session ID.
 *
 * @param  spdm_context                  A pointer to the SPDM context.
 * @param  session_id                    The SPDM session ID.
 *
 * @return session info.
 **/
void *libspdm_get_session_info_via_session_id(void *spdm_context, uint32_t session_id)
<span style = "background-color:#fdd">{</span>
    libspdm_context_t *context;
    libspdm_session_info_t *session_info;
    size_t index;

<span style = "background-color:#fdd">    if (session_id == INVALID_SESSION_ID) {
        LIBSPDM_DEBUG((LIBSPDM_DEBUG_ERROR,
                       "libspdm_get_session_info_via_session_id - Invalid session_id\n"));
        LIBSPDM_ASSERT(false);
        return NULL;</span>
    }

<span style = "background-color:#fdd">    context = spdm_context;</span>

<span style = "background-color:#fdd">    session_info = (libspdm_session_info_t *)context-&gt;session_info;
    for (index = 0; index &lt; LIBSPDM_MAX_SESSION_COUNT; index++) {
        if (session_info[index].session_id == session_id) {
            return &amp;session_info[index];</span>
        }
<span style = "background-color:#fdd">    }</span>

<span style = "background-color:#fdd">    LIBSPDM_DEBUG((LIBSPDM_DEBUG_ERROR,
                   "libspdm_get_session_info_via_session_id - not found session_id\n"));
    return NULL;
}</span>

/**
 * This function gets the secured message context via session ID.
 *
 * @param  spdm_context                  A pointer to the SPDM context.
 * @param  session_id                    The SPDM session ID.
 *
 * @return secured message context.
 **/
void *libspdm_get_secured_message_context_via_session_id(void *spdm_context, uint32_t session_id)
<span style = "background-color:#fdd">{</span>
    libspdm_session_info_t *session_info;

<span style = "background-color:#fdd">    session_info = libspdm_get_session_info_via_session_id(spdm_context, session_id);
    if (session_info == NULL) {
        return NULL;
    } else {
        return session_info-&gt;secured_message_context;</span>
    }
<span style = "background-color:#fdd">}</span>

/**
 * This function gets the secured message context via session ID.
 *
 * @param  spdm_session_info              A pointer to the SPDM context.
 *
 * @return secured message context.
 **/
void *libspdm_get_secured_message_context_via_session_info(void *spdm_session_info)
{
    libspdm_session_info_t *session_info;

    session_info = spdm_session_info;
    if (session_info == NULL) {
        return NULL;
    } else {
        return session_info-&gt;secured_message_context;
    }
}

/**
 * This function generate a new session ID by concatenating req_session_id and rsp_session_id.
 *
 * @param[in]  req_session_id
 * @param[in]  rsp_session_id
 *
 * @return this new session ID.
 **/
uint32_t libspdm_generate_session_id(uint16_t req_session_id, uint16_t rsp_session_id)
{
    uint32_t session_id;
    session_id = (rsp_session_id &lt;&lt; 16) | req_session_id;
    return session_id;
}

/**
 * This function assigns a new session ID.
 *
 * @param  spdm_context                  A pointer to the SPDM context.
 * @param  session_id                    The SPDM session ID.
 *
 * @return session info associated with this new session ID.
 **/
void *libspdm_assign_session_id(libspdm_context_t *spdm_context, uint32_t session_id, bool use_psk)
{
    libspdm_session_info_t *session_info;
    size_t index;

    if (session_id == INVALID_SESSION_ID) {
        LIBSPDM_DEBUG((LIBSPDM_DEBUG_ERROR, "libspdm_assign_session_id - Invalid session_id\n"));
        LIBSPDM_ASSERT(false);
        return NULL;
    }

    session_info = spdm_context-&gt;session_info;

    for (index = 0; index &lt; LIBSPDM_MAX_SESSION_COUNT; index++) {
        if (session_info[index].session_id == session_id) {
            LIBSPDM_DEBUG((LIBSPDM_DEBUG_ERROR,
                           "libspdm_assign_session_id - Duplicated session_id\n"));
            LIBSPDM_ASSERT(false);
            return NULL;
        }
    }

    for (index = 0; index &lt; LIBSPDM_MAX_SESSION_COUNT; index++) {
        if (session_info[index].session_id == INVALID_SESSION_ID) {
            libspdm_session_info_init(spdm_context,
                                      &amp;session_info[index], session_id,
                                      use_psk);
            spdm_context-&gt;latest_session_id = session_id;
            return &amp;session_info[index];
        }
    }

    LIBSPDM_DEBUG((LIBSPDM_DEBUG_ERROR, "libspdm_assign_session_id - MAX session_id\n"));
    return NULL;
}

/**
 * This function frees a session ID.
 *
 * @param  spdm_context                  A pointer to the SPDM context.
 * @param  session_id                    The SPDM session ID.
 **/
void libspdm_free_session_id(libspdm_context_t *spdm_context, uint32_t session_id)
<span style = "background-color:#fdd">{</span>
    libspdm_session_info_t *session_info;
    size_t index;

<span style = "background-color:#fdd">    if (session_id == INVALID_SESSION_ID) {
        LIBSPDM_DEBUG((LIBSPDM_DEBUG_ERROR, "libspdm_free_session_id - Invalid session_id\n"));
        LIBSPDM_ASSERT(false);
        return;</span>
    }

<span style = "background-color:#fdd">    if (spdm_context-&gt;latest_session_id == session_id) {
        spdm_context-&gt;latest_session_id = INVALID_SESSION_ID;</span>
    }

<span style = "background-color:#fdd">    session_info = spdm_context-&gt;session_info;
    for (index = 0; index &lt; LIBSPDM_MAX_SESSION_COUNT; index++) {
        if (session_info[index].session_id == session_id) {
            libspdm_session_info_init(spdm_context,</span>
                                      &amp;session_info[index],
                                      INVALID_SESSION_ID,
                                      session_info[index].use_psk);
<span style = "background-color:#fdd">            return;</span>
        }
<span style = "background-color:#fdd">    }</span>

<span style = "background-color:#fdd">    LIBSPDM_DEBUG((LIBSPDM_DEBUG_ERROR, "libspdm_free_session_id - MAX session_id\n"));
    LIBSPDM_ASSERT(false);
}</span></pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>