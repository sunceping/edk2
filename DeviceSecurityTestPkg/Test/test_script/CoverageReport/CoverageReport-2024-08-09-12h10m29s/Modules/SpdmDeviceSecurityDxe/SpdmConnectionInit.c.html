<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>SpdmConnectionInit.c</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
/** @file
  EDKII Device Security library for SPDM device.
  It follows the SPDM Specification.

Copyright (c) 2024, Intel Corporation. All rights reserved.&lt;BR&gt;
SPDX-License-Identifier: BSD-2-Clause-Patent

**/

#include "SpdmSecurityLibInternal.h"

LIST_ENTRY  mSpdmDeviceContextList = INITIALIZE_LIST_HEAD_VARIABLE (mSpdmDeviceContextList);

#define CONNECTUIN_FAILURE_GET_SPDM_UID_FAILED      "Fail to get Spdm Uid"
#define CONNECTUIN_FAILURE_STGNATURE_DB_FUL_STRING  "The Signature database devdb is full"

/**
  record Spdm Io protocol into the context list.

  @param[in]  SpdmDeviceContext      The SPDM context of the device.

**/
VOID
RecordSpdmDeviceContextInList (
  IN SPDM_DEVICE_CONTEXT  *SpdmDeviceContext
  )
<span style = "background-color:#dfd">{</span>
  SPDM_DEVICE_CONTEXT_INSTANCE  *NewSpdmDeviceContext;
  LIST_ENTRY                    *SpdmDeviceContextList;

<span style = "background-color:#dfd">  SpdmDeviceContextList = &amp;mSpdmDeviceContextList;</span>

<span style = "background-color:#dfd">  NewSpdmDeviceContext = AllocateZeroPool (sizeof (*NewSpdmDeviceContext));
  if (NewSpdmDeviceContext == NULL) {</span>
<span style = "background-color:#fdd">    ASSERT (NewSpdmDeviceContext != NULL);
    return;</span>
  }

<span style = "background-color:#dfd">  NewSpdmDeviceContext-&gt;Signature         = SPDM_DEVICE_CONTEXT_INSTANCE_SIGNATURE;
  NewSpdmDeviceContext-&gt;SpdmDeviceContext = SpdmDeviceContext;</span>

<span style = "background-color:#dfd">  InsertTailList (SpdmDeviceContextList, &amp;NewSpdmDeviceContext-&gt;Link);
}</span>

/**
  get Spdm Io protocol from Context list via spdm context.

  @param[in]  SpdmContext        The SPDM context of the requester.

  return a pointer to the Spdm Io protocol.

**/
VOID *
EFIAPI
GetSpdmIoProtocolViaSpdmContext (
  IN VOID  *SpdmContext
  )
<span style = "background-color:#dfd">{</span>
  LIST_ENTRY                    *Link;
  SPDM_DEVICE_CONTEXT_INSTANCE  *CurrentSpdmDeviceContext;
  LIST_ENTRY                    *SpdmDeviceContextList;

<span style = "background-color:#dfd">  SpdmDeviceContextList = &amp;mSpdmDeviceContextList;</span>

<span style = "background-color:#dfd">  Link = GetFirstNode (SpdmDeviceContextList);
  while (!IsNull (SpdmDeviceContextList, Link)) {
    CurrentSpdmDeviceContext = SPDM_DEVICE_CONTEXT_INSTANCE_FROM_LINK (Link);</span>

<span style = "background-color:#dfd">    if (CurrentSpdmDeviceContext-&gt;SpdmDeviceContext-&gt;SpdmContext == SpdmContext) {
      return CurrentSpdmDeviceContext-&gt;SpdmDeviceContext-&gt;SpdmIoProtocol;</span>
    }

<span style = "background-color:#fdd">    Link = GetNextNode (SpdmDeviceContextList, Link);
  }</span>

<span style = "background-color:#fdd">  return NULL;</span>
<span style = "background-color:#dfd">}</span>

/**
  creates and returns Spdm Uid from the volatile variable.

  @param[in]  SpdmUid        A pointer to Spdm Uid.

  @retval EFI_SUCCESS           Operation completed successfully.
  @retval EFI_OUT_OF_RESOURCES  Out of memory.
  @retval EFI_DEVICE_ERROR      The operation was unsuccessful.

**/
EFI_STATUS
GetSpdmUid (
  UINT64  *SpdmUid
  )
<span style = "background-color:#dfd">{</span>
  EFI_STATUS  Status;
  UINTN       VarSize;
  UINT64      Uid;

<span style = "background-color:#dfd">  VarSize = sizeof (*SpdmUid);
  Status  = gRT-&gt;GetVariable (</span>
                   L"SpdmUid",
                   &amp;gEfiDeviceSecuritySpdmUidGuid,
                   NULL,
                   &amp;VarSize,
                   &amp;Uid
                   );
<span style = "background-color:#dfd">  if (Status == EFI_NOT_FOUND) {
    Uid = 0;</span>
<span style = "background-color:#fdd">  } else if (EFI_ERROR (Status)) {
    return Status;</span>
  }

<span style = "background-color:#dfd">  *SpdmUid = Uid++;
  Status   = gRT-&gt;SetVariable (</span>
                    L"SpdmUid",
                    &amp;gEfiDeviceSecuritySpdmUidGuid,
                    EFI_VARIABLE_BOOTSERVICE_ACCESS,
                    sizeof (Uid),
                    &amp;Uid
                    );

<span style = "background-color:#dfd">  return Status;
}</span>

/**
  Record and log the connection failure string to PCR1.

  @param[in]  FailureString     The failure string.
  @param[in]  StringLen         The length of the string.

  @retval EFI_SUCCESS           Operation completed successfully.
  @retval EFI_OUT_OF_RESOURCES  Out of memory.
  @retval EFI_DEVICE_ERROR      The operation was unsuccessful.

**/
EFI_STATUS
RecordConnectionFailureStatus (
  IN CHAR8   *FailureString,
  IN UINT32  StringLen
  )
<span style = "background-color:#fdd">{</span>
  EFI_STATUS  Status;

<span style = "background-color:#fdd">  Status = TpmMeasureAndLogData (</span>
             1,
             EV_PLATFORM_CONFIG_FLAGS,
             FailureString,
             StringLen,
             FailureString,
             StringLen
             );
<span style = "background-color:#fdd">  DEBUG ((DEBUG_INFO, "RecordConnectionFailureStatus  %r\n", Status));
  return Status;
}</span>

/**
  This function creates the spdm device context and init connection to the
  responder with the device info.

  @param[in]  SpdmDeviceInfo        A pointer to device info.
  @param[out] SecurityState         A pointer to the security state of the requester.

  @return the spdm device conext after the init connection succeeds.

**/
SPDM_DEVICE_CONTEXT *
EFIAPI
CreateSpdmDeviceContext (
  IN  EDKII_SPDM_DEVICE_INFO       *SpdmDeviceInfo,
  OUT EDKII_DEVICE_SECURITY_STATE  *SecurityState
  )
<span style = "background-color:#dfd">{</span>
  SPDM_DEVICE_CONTEXT  *SpdmDeviceContext;
  VOID                 *SpdmContext;
  UINTN                SpdmContextSize;
  VOID                 *ScratchBuffer;
  UINTN                ScratchBufferSize;
  EFI_STATUS           Status;
  SPDM_RETURN          SpdmReturn;
  EFI_SIGNATURE_LIST   *DbList;
  EFI_SIGNATURE_DATA   *Cert;
  UINTN                CertCount;
  UINTN                Index;
  UINTN                SiglistHeaderSize;
  UINTN                DbSize;
  VOID                 *Data;
  UINTN                DataSize;
  SPDM_DATA_PARAMETER  Parameter;
  UINT8                Data8;
  UINT16               Data16;
  UINT32               Data32;
  UINT8                AuthState;

<span style = "background-color:#dfd">  SpdmDeviceContext = AllocateZeroPool (sizeof (*SpdmDeviceContext));
  if (SpdmDeviceContext == NULL) {</span>
<span style = "background-color:#fdd">    ASSERT (SpdmDeviceContext != NULL);
    return NULL;</span>
  }

<span style = "background-color:#dfd">  SpdmDeviceContext-&gt;Signature = SPDM_DEVICE_CONTEXT_SIGNATURE;
  CopyMem (&amp;SpdmDeviceContext-&gt;DeviceId, SpdmDeviceInfo-&gt;DeviceId, sizeof (EDKII_DEVICE_IDENTIFIER));
  SpdmDeviceContext-&gt;IsEmbeddedDevice = SpdmDeviceInfo-&gt;IsEmbeddedDevice;</span>

<span style = "background-color:#dfd">  SpdmContextSize = SpdmGetContextSize ();
  SpdmContext     = AllocateZeroPool (SpdmContextSize);
  if (SpdmContext == NULL) {</span>
<span style = "background-color:#fdd">    ASSERT (SpdmContext != NULL);
    goto Error;</span>
  }

<span style = "background-color:#dfd">  SpdmReturn = SpdmInitContext (SpdmContext);
  if (LIBSPDM_STATUS_IS_ERROR (SpdmReturn)) {</span>
<span style = "background-color:#fdd">    goto Error;</span>
  }

<span style = "background-color:#dfd">  SpdmRegisterDeviceIoFunc (</span>
    SpdmContext,
    SpdmDeviceInfo-&gt;SendMessage,
    SpdmDeviceInfo-&gt;ReceiveMessage
    );
<span style = "background-color:#dfd">  SpdmRegisterTransportLayerFunc (</span>
    SpdmContext,
    SpdmDeviceInfo-&gt;MaxSpdmMsgSize,
    SpdmDeviceInfo-&gt;TransportHeaderSize,
    SpdmDeviceInfo-&gt;TransportTailSize,
    SpdmDeviceInfo-&gt;TransportEncodeMessage,
    SpdmDeviceInfo-&gt;TransportDecodeMessage
    );

<span style = "background-color:#dfd">  SpdmRegisterDeviceBufferFunc (</span>
    SpdmContext,
    SpdmDeviceInfo-&gt;SenderBufferSize,
    SpdmDeviceInfo-&gt;ReceiverBufferSize,
    SpdmDeviceInfo-&gt;AcquireSenderBuffer,
    SpdmDeviceInfo-&gt;ReleaseSenderBuffer,
    SpdmDeviceInfo-&gt;AcquireReceiverBuffer,
    SpdmDeviceInfo-&gt;ReleaseReceiverBuffer
    );

<span style = "background-color:#dfd">  ScratchBufferSize = SpdmGetSizeofRequiredScratchBuffer (SpdmContext);
  ScratchBuffer     = AllocateZeroPool (ScratchBufferSize);
  if (ScratchBuffer == NULL) {</span>
<span style = "background-color:#fdd">    ASSERT (ScratchBuffer != NULL);
    goto Error;</span>
  }

<span style = "background-color:#dfd">  SpdmSetScratchBuffer (SpdmContext, ScratchBuffer, ScratchBufferSize);</span>

<span style = "background-color:#dfd">  SpdmDeviceContext-&gt;SpdmContextSize   = SpdmContextSize;
  SpdmDeviceContext-&gt;SpdmContext       = SpdmContext;
  SpdmDeviceContext-&gt;ScratchBufferSize = ScratchBufferSize;
  SpdmDeviceContext-&gt;ScratchBuffer     = ScratchBuffer;</span>

<span style = "background-color:#dfd">  Status = gBS-&gt;HandleProtocol (</span>
                  SpdmDeviceContext-&gt;DeviceId.DeviceHandle,
                  &amp;gEfiDevicePathProtocolGuid,
                  (VOID **)&amp;SpdmDeviceContext-&gt;DevicePath
                  );
<span style = "background-color:#dfd">  if (EFI_ERROR (Status)) {</span>
<span style = "background-color:#fdd">    DEBUG ((DEBUG_ERROR, "Locate - DevicePath - %r\n", Status));
    goto Error;</span>
  }

<span style = "background-color:#dfd">  Status = gBS-&gt;HandleProtocol (</span>
                  SpdmDeviceContext-&gt;DeviceId.DeviceHandle,
                  &amp;SpdmDeviceContext-&gt;DeviceId.DeviceType,
                  (VOID **)&amp;SpdmDeviceContext-&gt;DeviceIo
                  );
<span style = "background-color:#dfd">  if (EFI_ERROR (Status)) {</span>
<span style = "background-color:#fdd">    DEBUG ((DEBUG_ERROR, "Locate - DeviceIo - %r\n", Status));</span>
    // This is optional, only check known device type later.
  }

<span style = "background-color:#dfd">  if (SpdmDeviceInfo-&gt;SpdmIoProtocolGuid != NULL) {
    Status = gBS-&gt;HandleProtocol (</span>
                    SpdmDeviceContext-&gt;DeviceId.DeviceHandle,
                    SpdmDeviceInfo-&gt;SpdmIoProtocolGuid,
                    (VOID **)&amp;SpdmDeviceContext-&gt;SpdmIoProtocol
                    );
<span style = "background-color:#dfd">    if (EFI_ERROR (Status)) {</span>
<span style = "background-color:#fdd">      DEBUG ((DEBUG_ERROR, "Locate - SpdmIoProtocol - %r\n", Status));
      goto Error;</span>
    }
  }

<span style = "background-color:#dfd">  if (CompareGuid (&amp;SpdmDeviceContext-&gt;DeviceId.DeviceType, &amp;gEdkiiDeviceIdentifierTypePciGuid)) {
    if (SpdmDeviceContext-&gt;DeviceIo == NULL) {</span>
<span style = "background-color:#fdd">      DEBUG ((DEBUG_ERROR, "Locate - PciIo - %r\n", Status));
      goto Error;</span>
    }
  }

<span style = "background-color:#dfd">  Status = GetSpdmUid (&amp;SpdmDeviceContext-&gt;DeviceUID);
  if (EFI_ERROR (Status)) {</span>
<span style = "background-color:#fdd">    Status = RecordConnectionFailureStatus (</span>
               CONNECTUIN_FAILURE_GET_SPDM_UID_FAILED,
               sizeof (CONNECTUIN_FAILURE_GET_SPDM_UID_FAILED)
               );
<span style = "background-color:#fdd">    if (EFI_ERROR (Status)) {
      goto Error;</span>
    }

<span style = "background-color:#fdd">    ASSERT (FALSE);
    DEBUG ((DEBUG_ERROR, "Fail to get UID - %r\n", Status));
    goto Error;</span>
  }

<span style = "background-color:#dfd">  RecordSpdmDeviceContextInList (SpdmDeviceContext);</span>

<span style = "background-color:#dfd">  Status = GetVariable2 (</span>
             EFI_DEVICE_SECURITY_DATABASE,
             &amp;gEfiDeviceSignatureDatabaseGuid,
             (VOID **)&amp;SpdmDeviceContext-&gt;SignatureList,
             &amp;SpdmDeviceContext-&gt;SignatureListSize
             );
<span style = "background-color:#dfd">  if ((!EFI_ERROR (Status)) &amp;&amp; (SpdmDeviceContext-&gt;SignatureList != NULL)) {
    DbList = SpdmDeviceContext-&gt;SignatureList;
    DbSize = SpdmDeviceContext-&gt;SignatureListSize;
    while ((DbSize &gt; 0) &amp;&amp; (SpdmDeviceContext-&gt;SignatureListSize &gt;= DbList-&gt;SignatureListSize)) {
      if (DbList-&gt;SignatureListSize == 0) {</span>
<span style = "background-color:#fdd">        break;</span>
      }

      if (  (!CompareGuid (&amp;DbList-&gt;SignatureType, &amp;gEfiCertX509Guid))
         || (DbList-&gt;SignatureHeaderSize != 0)
<span style = "background-color:#dfd">         || (DbList-&gt;SignatureSize &lt; sizeof (EFI_SIGNATURE_DATA)))</span>
      {
<span style = "background-color:#dfd">        DbSize -= DbList-&gt;SignatureListSize;
        DbList  = (EFI_SIGNATURE_LIST *)((UINT8 *)DbList + DbList-&gt;SignatureListSize);
        continue;</span>
      }

<span style = "background-color:#dfd">      SiglistHeaderSize = sizeof (EFI_SIGNATURE_LIST) + DbList-&gt;SignatureHeaderSize;
      Cert              = (EFI_SIGNATURE_DATA *)((UINT8 *)DbList + SiglistHeaderSize);
      CertCount         = (DbList-&gt;SignatureListSize - SiglistHeaderSize) / DbList-&gt;SignatureSize;</span>

<span style = "background-color:#dfd">      for (Index = 0; Index &lt; CertCount; Index++) {
        Data     = Cert-&gt;SignatureData;
        DataSize = DbList-&gt;SignatureSize - sizeof (EFI_GUID);</span>

<span style = "background-color:#dfd">        ZeroMem (&amp;Parameter, sizeof (Parameter));
        Parameter.location = SpdmDataLocationLocal;
        SpdmReturn         = SpdmSetData (SpdmContext, SpdmDataPeerPublicRootCert, &amp;Parameter, Data, DataSize);
        if (LIBSPDM_STATUS_IS_ERROR (SpdmReturn)) {</span>
<span style = "background-color:#fdd">          if (SpdmReturn == LIBSPDM_STATUS_BUFFER_FULL) {
            Status = RecordConnectionFailureStatus (</span>
                       CONNECTUIN_FAILURE_STGNATURE_DB_FUL_STRING,
                       sizeof (CONNECTUIN_FAILURE_STGNATURE_DB_FUL_STRING)
                       );
<span style = "background-color:#fdd">            if (EFI_ERROR (Status)) {
              goto Error;</span>
            }

<span style = "background-color:#fdd">            ASSERT (FALSE);</span>
          }

<span style = "background-color:#fdd">          goto Error;</span>
        }

<span style = "background-color:#dfd">        Cert = (EFI_SIGNATURE_DATA *)((UINT8 *)Cert + DbList-&gt;SignatureSize);
      }</span>

<span style = "background-color:#dfd">      DbSize -= DbList-&gt;SignatureListSize;
      DbList  = (EFI_SIGNATURE_LIST *)((UINT8 *)DbList + DbList-&gt;SignatureListSize);
    }</span>
  }

<span style = "background-color:#dfd">  Data8 = 0;
  ZeroMem (&amp;Parameter, sizeof (Parameter));
  Parameter.location = SpdmDataLocationLocal;
  SpdmReturn         = SpdmSetData (SpdmContext, SpdmDataCapabilityCTExponent, &amp;Parameter, &amp;Data8, sizeof (Data8));
  if (LIBSPDM_STATUS_IS_ERROR (SpdmReturn)) {</span>
<span style = "background-color:#fdd">    ASSERT (FALSE);
    goto Error;</span>
  }

<span style = "background-color:#dfd">  Data32     = 0;
  SpdmReturn = SpdmSetData (SpdmContext, SpdmDataCapabilityFlags, &amp;Parameter, &amp;Data32, sizeof (Data32));
  if (LIBSPDM_STATUS_IS_ERROR (SpdmReturn)) {</span>
<span style = "background-color:#fdd">    ASSERT (FALSE);
    goto Error;</span>
  }

<span style = "background-color:#dfd">  Data8      = SPDM_MEASUREMENT_SPECIFICATION_DMTF;
  SpdmReturn = SpdmSetData (SpdmContext, SpdmDataMeasurementSpec, &amp;Parameter, &amp;Data8, sizeof (Data8));
  if (LIBSPDM_STATUS_IS_ERROR (SpdmReturn)) {</span>
<span style = "background-color:#fdd">    ASSERT (FALSE);
    goto Error;</span>
  }

<span style = "background-color:#dfd">  if (SpdmDeviceInfo-&gt;BaseAsymAlgo != 0) {</span>
<span style = "background-color:#fdd">    Data32 = SpdmDeviceInfo-&gt;BaseAsymAlgo;
  } else {</span>
<span style = "background-color:#dfd">    Data32 = SPDM_ALGORITHMS_BASE_ASYM_ALGO_TPM_ALG_RSASSA_2048 |</span>
             SPDM_ALGORITHMS_BASE_ASYM_ALGO_TPM_ALG_RSASSA_3072 |
             SPDM_ALGORITHMS_BASE_ASYM_ALGO_TPM_ALG_RSASSA_4096 |
             SPDM_ALGORITHMS_BASE_ASYM_ALGO_TPM_ALG_ECDSA_ECC_NIST_P256 |
             SPDM_ALGORITHMS_BASE_ASYM_ALGO_TPM_ALG_ECDSA_ECC_NIST_P384 |
             SPDM_ALGORITHMS_BASE_ASYM_ALGO_TPM_ALG_ECDSA_ECC_NIST_P521;
  }

<span style = "background-color:#dfd">  SpdmReturn = SpdmSetData (SpdmContext, SpdmDataBaseAsymAlgo, &amp;Parameter, &amp;Data32, sizeof (Data32));
  if (LIBSPDM_STATUS_IS_ERROR (SpdmReturn)) {</span>
<span style = "background-color:#fdd">    ASSERT (FALSE);
    goto Error;</span>
  }

<span style = "background-color:#dfd">  if (SpdmDeviceInfo-&gt;BaseHashAlgo != 0) {</span>
<span style = "background-color:#fdd">    Data32 = SpdmDeviceInfo-&gt;BaseHashAlgo;
  } else {</span>
<span style = "background-color:#dfd">    Data32 = SPDM_ALGORITHMS_BASE_HASH_ALGO_TPM_ALG_SHA_256 |</span>
             SPDM_ALGORITHMS_BASE_HASH_ALGO_TPM_ALG_SHA_384 |
             SPDM_ALGORITHMS_BASE_HASH_ALGO_TPM_ALG_SHA_512;
  }

<span style = "background-color:#dfd">  SpdmReturn = SpdmSetData (SpdmContext, SpdmDataBaseHashAlgo, &amp;Parameter, &amp;Data32, sizeof (Data32));
  if (LIBSPDM_STATUS_IS_ERROR (SpdmReturn)) {</span>
<span style = "background-color:#fdd">    ASSERT (FALSE);
    goto Error;</span>
  }

<span style = "background-color:#dfd">  SpdmReturn = SpdmInitConnection (SpdmContext, FALSE);
  if (LIBSPDM_STATUS_IS_ERROR (SpdmReturn)) {
    DEBUG ((DEBUG_ERROR, "SpdmInitConnection - %p\n", SpdmReturn));</span>

<span style = "background-color:#dfd">    AuthState                          = TCG_DEVICE_SECURITY_EVENT_DATA_DEVICE_AUTH_STATE_NO_SPDM;
    SecurityState-&gt;AuthenticationState = EDKII_DEVICE_SECURITY_STATE_ERROR_DEVICE_NO_CAPABILITIES;
    Status                             = ExtendCertificate (SpdmDeviceContext, AuthState, 0, NULL, NULL, 0, 0, SecurityState);
    if (Status != EFI_SUCCESS) {</span>
<span style = "background-color:#fdd">      DEBUG ((DEBUG_ERROR, "ExtendCertificate  AUTH_STATE_NO_SPDM failed\n"));</span>
    }

<span style = "background-color:#dfd">    goto Error;</span>
  }

<span style = "background-color:#dfd">  ZeroMem (&amp;Parameter, sizeof (Parameter));
  Parameter.location = SpdmDataLocationConnection;
  DataSize           = sizeof (Data16);
  SpdmReturn         = SpdmGetData (SpdmContext, SpdmDataSpdmVersion, &amp;Parameter, &amp;Data16, &amp;DataSize);
  if (LIBSPDM_STATUS_IS_ERROR (SpdmReturn)) {</span>
<span style = "background-color:#fdd">    DEBUG ((DEBUG_ERROR, "SpdmGetData - %p\n", SpdmReturn));
    goto Error;</span>
  }

<span style = "background-color:#dfd">  SpdmDeviceContext-&gt;SpdmVersion = (Data16 &gt;&gt; SPDM_VERSION_NUMBER_SHIFT_BIT);</span>

<span style = "background-color:#dfd">  return SpdmDeviceContext;</span>
Error:
<span style = "background-color:#dfd">  DestroySpdmDeviceContext (SpdmDeviceContext);
  return NULL;
}</span>

/**
  This function destories the spdm device context.

  @param[in]  SpdmDeviceContext      A pointer to device info.

**/
VOID
EFIAPI
DestroySpdmDeviceContext (
  IN SPDM_DEVICE_CONTEXT  *SpdmDeviceContext
  )
<span style = "background-color:#dfd">{</span>
  // need zero memory in case of secret in memory.
<span style = "background-color:#dfd">  if (SpdmDeviceContext-&gt;SpdmContext != NULL) {
    ZeroMem (SpdmDeviceContext-&gt;SpdmContext, SpdmDeviceContext-&gt;SpdmContextSize);
    FreePool (SpdmDeviceContext-&gt;SpdmContext);</span>
  }

<span style = "background-color:#dfd">  if (SpdmDeviceContext-&gt;ScratchBuffer != NULL) {
    ZeroMem (SpdmDeviceContext-&gt;ScratchBuffer, SpdmDeviceContext-&gt;ScratchBufferSize);
    FreePool (SpdmDeviceContext-&gt;ScratchBuffer);</span>
  }

<span style = "background-color:#dfd">  if (SpdmDeviceContext-&gt;SignatureList != NULL) {
    ZeroMem (SpdmDeviceContext-&gt;SignatureList, SpdmDeviceContext-&gt;SignatureListSize);
    FreePool (SpdmDeviceContext-&gt;SignatureList);</span>
  }

<span style = "background-color:#dfd">  FreePool (SpdmDeviceContext);
}</span></pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>